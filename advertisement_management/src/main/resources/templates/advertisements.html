<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advertisement Management</title>
  <link rel="stylesheet" href="/static/css/advertisement.css">
</head>
<body>
<div class="container">
  <h1>Advertisement Management</h1>

  <h2>Create Advertisement</h2>
  <form id="createAdForm" enctype="multipart/form-data">
    <input type="text" id="adTitle" name="adName" placeholder="Title" required>
    <input type="file" id="adImage" name="adImages" accept="image/*" multiple required>
    <input type="text" id="adFeature" name="adFeature" placeholder="Feature" required>
    <button type="submit">Create</button>
  </form>

  <h2>Advertisements List</h2>
  <ul id="adList"></ul>

  <h2>Advertisement Details</h2>
  <div id="adDetails"></div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const createAdForm = document.getElementById('createAdForm');
    const adList = document.getElementById('adList');
    const adDetails = document.getElementById('adDetails');

    fetchAllAdvertisements();

    createAdForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const adTitle = e.target.adTitle.value;
      const adImages = e.target.adImage.files;
      const adFeature = e.target.adFeature.value;

      const formData = new FormData();
      formData.append('adName', adTitle);
      formData.append('adFeature', adFeature);

      // 遍历并添加所有图片文件
      for (let i = 0; i < adImages.length; i++) {
        formData.append('adImages', adImages[i]);
      }

      createAdvertisement(formData);
      e.target.reset();
    });

    function createAdvertisement(advertisement) {
      fetch('/advertisements/create', {
        method: 'POST',
        body: advertisement
      })
              .then(() => fetchAllAdvertisements())
              .catch(error => console.error('Error creating advertisement:', error));
    }

    function fetchAllAdvertisements() {
      fetch('/advertisements/all')
              .then(response => response.json())
              .then(data => {
                adList.innerHTML = '';
                data.forEach(ad => {
                  const li = document.createElement('li');
                  li.textContent = ad.adName || 'Untitled';
                  li.addEventListener('click', () => fetchAdvertisementDetails(ad.adId));
                  adList.appendChild(li);
                });
              })
              .catch(error => console.error('Error fetching advertisements:', error));
    }

    function fetchAdvertisementDetails(adId) {
      fetch(`/advertisements/${adId}`)
              .then(response => response.json())
              .then(data => {
                // 解析图片URL的JSON字符串
                const imageUrls = JSON.parse(data.adImageUrl);

                adDetails.innerHTML = `
                <p><strong>Title:</strong> ${data.adName || 'Untitled'}</p>
                <p><strong>Feature:</strong> ${data.adFeature || 'No feature provided'}</p>
                <p><strong>Images:</strong></p>
            `;

                // 遍历所有图片URL，并为每个URL创建一个img元素
                imageUrls.forEach(imageUrl => {
                  const img = document.createElement('img');
                  img.src = imageUrl;
                  img.alt = 'Advertisement Image';
                  adDetails.appendChild(img);
                });

                // 添加跳转到广告详细页面的链接
                const viewDetailsLink = document.createElement('a');
                viewDetailsLink.href = `/ad/${adId}`;
                viewDetailsLink.textContent = 'View Details';
                adDetails.appendChild(viewDetailsLink);
              })
              .catch(error => console.error('Error fetching advertisement details:', error));
    }
  });
</script>
</body>
</html>